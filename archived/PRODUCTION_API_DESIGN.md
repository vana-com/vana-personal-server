# Production API Design for Agent Operations

## Current State Issues

1. **Artifacts in JSON**: Base64 encoded artifacts bloat response, don't scale
2. **No direct access**: Applications can't download artifacts separately
3. **No access control**: Anyone with operation ID can see results
4. **No storage lifecycle**: Results lost on restart, no expiration

## Production API Design

### **Enhanced Operation Response**
```yaml
GetOperationResponse:
  properties:
    id: 
      type: string
    status:
      type: string
      enum: [pending, running, succeeded, failed, cancelled]
    started_at:
      type: string
      format: date-time
    finished_at:
      type: string
      format: date-time
    result:
      $ref: '#/components/schemas/OperationResult'
    artifacts:
      $ref: '#/components/schemas/ArtifactCollection'

OperationResult:
  properties:
    status:
      type: string
      enum: [ok, error]
    summary:
      type: string
    execution_time:
      type: number
      description: "Execution time in seconds"
    logs:
      type: array
      items:
        type: string

ArtifactCollection:
  properties:
    count:
      type: integer
    total_size:
      type: integer
      description: "Total size of all artifacts in bytes"
    artifacts:
      type: array
      items:
        $ref: '#/components/schemas/ArtifactMetadata'

ArtifactMetadata:
  properties:
    name:
      type: string
      example: "privacy_audit.md"
    size:
      type: integer
      example: 4096
    content_type:
      type: string
      example: "text/markdown"
    created_at:
      type: string
      format: date-time
    download_url:
      type: string
      example: "/api/v1/operations/{id}/artifacts/{name}"
    checksum:
      type: string
      description: "SHA-256 hash for integrity verification"
```

### **New Artifact Endpoints**

```yaml
paths:
  /operations/{operation_id}/artifacts:
    get:
      summary: List operation artifacts
      description: |
        Returns metadata for all artifacts generated by an operation.
        Only accessible by the original grantee with valid signature.
      parameters:
        - name: operation_id
          in: path
          required: true
          schema:
            type: string
        - name: signature
          in: header
          required: true
          description: "Signature proving access rights"
          schema:
            type: string
      responses:
        '200':
          description: Artifact list retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtifactCollection'
        '403':
          description: Access denied
        '404':
          description: Operation not found

  /operations/{operation_id}/artifacts/{artifact_name}:
    get:
      summary: Download specific artifact
      description: |
        Downloads the content of a specific artifact.
        Content is encrypted and must be decrypted by the client.
      parameters:
        - name: operation_id
          in: path
          required: true
          schema:
            type: string
        - name: artifact_name
          in: path
          required: true
          schema:
            type: string
        - name: signature
          in: header
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Artifact content
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
          headers:
            Content-Type:
              schema:
                type: string
            Content-Length:
              schema:
                type: integer
            X-Artifact-Checksum:
              schema:
                type: string
        '403':
          description: Access denied
        '404':
          description: Artifact not found

  /operations/{operation_id}/artifacts/{artifact_name}:
    delete:
      summary: Delete specific artifact
      description: |
        Permanently deletes an artifact.
        Only allowed by the original grantee before expiration.
      responses:
        '204':
          description: Artifact deleted successfully
        '403':
          description: Access denied
        '404':
          description: Artifact not found
```

## Storage Architecture

### **Artifact Storage Service**
```python
class ArtifactStorageService:
    """Manages encrypted artifact storage with access control."""
    
    async def store_artifacts(
        self, 
        operation_id: str,
        artifacts: List[Artifact],
        grantee_address: str,
        expiration: datetime
    ) -> ArtifactCollection:
        """Store artifacts with encryption and metadata."""
        pass
    
    async def get_artifact_metadata(
        self,
        operation_id: str,
        requesting_address: str
    ) -> ArtifactCollection:
        """Get artifact metadata if access permitted."""
        pass
    
    async def download_artifact(
        self,
        operation_id: str, 
        artifact_name: str,
        requesting_address: str
    ) -> bytes:
        """Download encrypted artifact content."""
        pass
    
    async def cleanup_expired_artifacts(self):
        """Background task to cleanup expired artifacts."""
        pass
```

### **Directory Structure**
```
artifacts/
├── operations/
│   └── {operation_id}/
│       ├── metadata.json              # Encrypted metadata
│       ├── artifacts/
│       │   ├── privacy_audit.md.enc   # Encrypted artifact
│       │   ├── code_analysis.py.enc   # Encrypted artifact  
│       │   └── recommendations.json.enc
│       └── access_log.json            # Audit trail
```

### **Metadata Format**
```json
{
  "operation_id": "gemini_1755985390841",
  "grantee_address": "0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6",
  "created_at": "2024-08-23T21:35:38.000Z",
  "expires_at": "2024-08-30T21:35:38.000Z",
  "encryption_key_encrypted": "...",  # Encrypted with grantee's public key
  "total_size": 8192,
  "artifacts": [
    {
      "name": "privacy_audit.md",
      "path": "artifacts/privacy_audit.md.enc",
      "size": 4096,
      "content_type": "text/markdown",
      "checksum": "sha256:abc123...",
      "created_at": "2024-08-23T21:35:45.000Z"
    }
  ]
}
```

## Security Model

### **Access Control**
1. **Signature Verification**: All artifact requests must be signed by grantee
2. **Operation Ownership**: Only grantee who created operation can access artifacts
3. **Temporal Access**: Artifacts expire with original permission
4. **Audit Trail**: All access logged with timestamps and addresses

### **Encryption Strategy**
1. **Artifact Encryption**: Each artifact encrypted with unique key
2. **Key Management**: Artifact keys encrypted with grantee's public key
3. **In-Transit Protection**: HTTPS for all artifact transfers
4. **At-Rest Protection**: Encrypted storage with regular key rotation

## Resource Management

### **Limits and Quotas**
```python
AGENT_RESOURCE_LIMITS = {
    "max_execution_time": 600,      # 10 minutes
    "max_disk_usage": 1_000_000_000, # 1GB
    "max_artifact_count": 50,       # Max files per operation
    "max_artifact_size": 100_000_000, # 100MB per file
    "artifact_retention_days": 7,   # Auto-cleanup after 7 days
}
```

### **Background Tasks**
```python
@background_task(interval="1h")
async def cleanup_expired_artifacts():
    """Remove artifacts past expiration date."""
    pass

@background_task(interval="5m") 
async def monitor_resource_usage():
    """Alert on resource limit violations."""
    pass
```

## Migration Strategy

### **Phase 1: Backward Compatibility**
- Keep existing embedded artifacts in operation response
- Add new artifact metadata fields
- Implement artifact storage service
- Add artifact endpoints (optional)

### **Phase 2: Deprecation**
- Mark embedded artifacts as deprecated
- Encourage clients to use artifact endpoints
- Add warnings for large embedded artifacts

### **Phase 3: Migration**
- Remove embedded artifacts from responses
- All artifacts accessed via dedicated endpoints
- Enhanced security and performance